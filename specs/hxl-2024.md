# HXL.2024

## Introduction

**HXL** is a data interchange format similar to JSON or YAML, but sporting
additional features which are more dynamic in nature, such as inheritance
and references.

It was originally designed to function as data storage for a game engine, containing
descriptions about objects, materials and lights.

## Design goal

The design goal is to make HXL:

- Useful
- Streamlined
- Easy to parse

## Lexical structure

### Character set

HXL's structures can be covered in ASCII range, but implementations
must support **Unicode** to provide cross-platform and cross-language flexibility
in the data.

### Basic syntax

An HXL file consists of one or more **nodes**.
Every node consists of zero, one or more **properties**.

An example from a game engine would be:

````text
<Player> MainCharacter
    health: 100
    ammo: 50
````

## Data types

### String

String values must be defined between quotes.

````text
<Player> MainCharacter
    name: "John Doe"
````

#### Special characters

- Character escaping is achieved with backslash.
- Inside a string ``#`` must NOT be interpreted as the beginning of a comment.
- Inside a string ``:`` should NOT cause tokenization error, and must be considered part of the string.

### Integer

````text
<Player> MainCharacter
    int: 45
````

Values can be negative or positive.

Scientific notation, hexadecimal and similar forms are NOT supported.

### Float-point

````text
<Player> MainCharacter
    float: -10.5
````

Scientific notation, hexadecimal and similar forms are NOT supported.

Values can be negative or positive.

### Reference

A property can be a reference to another node.

To indicate a reference, the property name must be suffixed by ``&``.

The value of the property is the exact name of the node.

````text
<Player> MainCharacter
    age: 45
    
<Enemy> Monster
    target&: MainCharacter
````

### Array

Arrays are denoted by suffixing the property name with ``[]``.

The values must be declared between ``{`` and ``}``.

Each value must be separated by comma (``,``).

````text
<Cube3D> CubeA
    position[] = { 2, 4, -2 }
````

As of 2024, only strings, integer and float values are allowed as array values.

## Features

### Inheritance

Inheritance means a node will copy all the properties from another node,
and override the properties explicitly defined.

Example:

````text
<Enemy> MonsterOne
    health: 100
    position[]: { 4, 0, 4 }
    
<Enemy> MonsterTwo <= MonsterOne
    position[]: { 8, 0 , 8 }
````

In this example, ``MonsterTwo`` implicitly copies ``health`` (as 100).

As of 2024 specification, a node can only inherit ONE node.

### Comments

Any text following ``#`` on any line should be ignored, with the only
exception being when the ``#`` is within a string literal.

## Rules

### Syntax

The code in the bracket, in front of a point, indicates which error
code must be thrown when the criteria isn't met.

#### Nodes

- [``HXL_INVALID_NODE_FORM``] A node declaration requires a node type and a name, provided on the form: ``<Type> Name``
- [``HXL_ILLEGAL_WHITESPACE``] There MUST be a single whitespace (``\s``) between the type and the name.

#### Properties

- [``HXL_ILLEGAL_WHITESPACE``] Every node property MUST be preceded by a _single_ tab (``\t``)
- [``HXL_INVALID_PROPERTY_FORM``] The first colon (``:``) marks which part is the key and which is the value.
- [``HXL_ILLEGAL_WHITESPACE``] Any type of whitespace between property name and ``:`` is NOT allowed.
- [``HXL_ILLEGAL_WHITESPACE``] A single whitespace ``\s`` MUST succeed ``:`` and precede the value.
- Everything after the ``:`` (except for the initial, required whitespace) MUST be considered
  part of the value.

#### Data types

- **Strings**:
    - Character escapes are preceded backslash, for example ``\"``.
- **Integer**
    - Integer values MUST be given on the form ``-x`` or ``x`` (example: ``-5`` or ``11``)
    - As of 2024, scientific, hexadecimal and other numeric notations are NOT supported.
- **Float-pointer**:
    - [``HXL_ILLEGAL_FLOAT``] Float values are ONLY valid when a decimal is present, with at least one decimal.
      (example: ``-5.05``)
    - [``HXL_ILLEGAL_FLOAT``] Values on the form ``-5`` or ``5`` MUST NOT be automatically cast to float-pointer value.
    - As of 2024, scientific, hexadecimal and other numeric notations are NOT supported.
- **Arrays**
    - [``HXL_ILLEGAL_WHITESPACE``] Array values MUST be encapsulated between ``{`` and ``}`` with EXACTLY
      one whitespace character (``\s``) separating the braces from the values.
    - [``HXL_ILLEGAL_WHITESPACE``] The values MUST have EXACTLY one whitespace character (``\s``) preceding it,
      and be separated by a comma (``,``). Example: ``{ 2, 3, 4 }``
    - [``HXL_ARRAY_MIXED_TYPES``] Arrays values MUST be of identical type.
    - [``HXL_ARRAY_UNKNOWN_TYPE``] Array values MUST be either string, integer or float.
    - Nested arrays and references are NOT supported.
- **References**
    - Property key must be suffixed with ``&``.
    - [``HXL_ILLEGAL_WHITESPACE``] No white NO whitespace around it (example ``key&: value``).

#### Comments

- Any text following ``#`` MUST be ignored, EXCEPT when the character is found inside a string literal.

#### Inheritance

- There MUST be exactly ONE whitespace character (``\s``) on each side of the ``<=`` token.

### Structure validation

- [``HXL_NODE_REFERENCE_NOT_FOUND``] Referenced nodes MUST exist.
- [``HXL_NODE_REFERENCE_NOT_FOUND``] Referenced nodes MUST be declared earlier in the HXL file
- [``HXL_CIRCULAR_NODE_REFERENCE``] Circular references MUST cause an error.
- [``HXL_ILLEGAL_REFERENCE``] A node CANNOT reference itself
- [``HXL_INHERIT_DIFF_TYPES``] An inherited node MUST have the EXACT same node type.
- [``HXL_NODE_REFERENCE_NOT_FOUND``] An inherited node MUST exist.
- [``HXL_NODE_REFERENCE_NOT_FOUND``] An inherited node MUST be declared earlier in the file.
- [``HXL_ILLEGAL_INHERITANCE``] A node CANNOT inherit itself.

### Name validation

| Subject        | Regular expression      | Example            | Error code                   |
|----------------|-------------------------|--------------------|------------------------------|
| Node data type | ``([A-Z][a-z]+){1,}``   | ``NodeType``       | ``HXL_INVALID_NODE_TYPE``    |
| Node name      | ``([A-Z][a-zA-Z0-9]+)`` | ``MyNode3D``       | ``HXL_INVALID_NODE_NAME``    |
| Property key   | ``[a-z][a-z_]+``        | ``albedo_texture`` | ``HXL_INVALID_PROPERTY_KEY`` |

### Schema validation

You can read more about the schema under **Implementation nodes**

- [``HXL_UNKNOWN_NODE_TYPE``] When a node type is not part of the schema
- [``HXL_ILLEGAL_DATA_TYPE``] When the value of a property doesn't match the schema
- [``HXL_REQUIRED_PROPERTY_NOT_FOUND``] Required node property not found
- [``HXL_UNKNOWN_PROPERTY``] A property NOT found in the schema was provided

## Implementation notes

### Schema

Implementations should provide a schema which outlines:

- Supported node types
- Supported properties on a per node type basis
- The data type of each property
- Whether a data type is required
- (Optional) Default values for properties

### Pipeline

The recommended pipeline is:

- Tokenization
- Grammar validation
- Pre-schema validation
- Schema validation
- Translate to language-specific objects

**Tokenization** is the process of scanning the file, essentially by moving
a cursor over every character. During this process, you build tens, hundreds or
thousands of tokens.

Example, in the following:

`````text
<NodeType> NodeName <= ParentNode
`````

It could be tokenized as:

- ``<`` (Delimiter)
- ``NodeType`` (Identifier)
- ``>`` (Delimiter)
- ``NodeName`` (Identifier)
- ``<=`` (Delimiter)
- ``ParentNode`` (Identifier)

In the **grammar validation** you verify the order the tokens are provided
in. Building on the example above, we would expect an identifier to follow
the ``<`` delimiter. If that isn't the case, we encounter "an unexpected token."

In the **pre-schema validation**, you verify structures prior to using the
schema. This, for example, verifying that an array doesn't have mixed types
or verifying that references exist.

In the **schema validation** stage, you hold the structure up
against the schema. Here you verify that node types are correct, that
required properties exist, that unrecognized properties are caught, etc.

In the final stage, **translation to language-specific objects**,
the results are provided in objects which are readable by the implementation
language. This could be structs, classes or something else.

For C++, it could be a struct, in PHP an array with nested associative arrays.
This step might be more difficult in language which have limited reflection
capabilities.

### Other notes

It's recommended to design your implementation such that you support
multiple specifications, and the client can select which one
they adhere to.

It's also recommended that implementations which are to be used across
different projects, such as generalized libraries for HXL, provide a
way to dynamically select which features to allow. Not all of HXL's features
are fit for every kind of project.

Node types, node names and properties are case-sensitive.

## Error handling

When implementing HXL, you should provide these error codes to make sure
implementations are streamlined.

### Tokenization and parsing errors

| Error code                    | Description                                                         |
|-------------------------------|---------------------------------------------------------------------|
| ``HXL_UNEXPECTED_TOKEN``      | When invalid characters are found in the initial tokenization.      | |
| ``HXL_ILLEGAL_WHITESPACE``    | Wrong type of whitespace, or disallowed omission.                   |
| ``HXL_INVALID_NODE_FORM``     | A node is not specified on the correct form with a type and a name. |
| ``HXL_INVALID_PROPERTY_FORM`` | A line where a property is expected, does not include a ``:``       |

### Pre-schema validation errors

Validation that must be carried out prior to validating the values against the schema.

| Error code                       | Description                                                                                                                                                       |
|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ``HXL_ARRAY_MIXED_TYPES``        | Mixed data types in an array. Example: ``{ "Hello", 2, 3 }``                                                                                                      |
| ``HXL_ARRAY_UNKNOWN_TYPE``       | When anything other than string, integer or float is found in an array                                                                                            |
| ``HXL_NODE_REFERENCE_NOT_FOUND`` | When a referenced node hasn't been defined at an earlier point in the HXL file.                                                                                   |
| ``HXL_CIRCULAR_NODE_REFERENCE``  | When node A references B, which then references A. This is automatically prevented if properly implemented that a referenced node MUST exist earlier in the file. |
| ``HXL_INHERIT_DIFF_TYPES``       | The inherited node is of a different type than the child node.                                                                                                    |
| ``HXL_ILLEGAL_INHERITANCE``      | When a node attempts to inherit itself.                                                                                                                           |
| ``HXL_ILLEGAL_REFERENCE``        | When a node property attempts to reference the node itself.                                                                                                       |
| ``HXL_INVALID_NODE_TYPE``        | The node type in ``<NodeType>`` is doesn't adhere to the regular expression.                                                                                      |
| ``HXL_INVALID_NODE_NAME``        | The node name doesn't adhere to the corresponding regular expression.                                                                                             |
| ``HXL_INVALID_PROPERTY_KEY``     | The property key doesn't adhere to the regular expression.                                                                                                        |
| ``HXL_ILLEGAL_FLOAT``            | The format of the float-pointer value is not allowed (most likely given as integer)                                                                               |

### Schema validation errors

When validating a schema, these error codes must be used:

| Error code                          | Description                                                 |
|-------------------------------------|-------------------------------------------------------------|
| ``HXL_UNKNOWN_NODE_TYPE``           | The node type is not found in the schema.                   |
| ``HXL_ILLEGAL_DATA_TYPE``           | Schema expects one data type, but another is provided.      |
| ``HXL_REQUIRED_PROPERTY_NOT_FOUND`` | A property required in the schema is not found on the node. |
| ``HXL_UNKNOWN_PROPERTY``            | A property not declared in the schema is found on the node. |
